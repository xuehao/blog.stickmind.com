Title: 搭建 C 的编程环境
Slug: build-a-c-programming-environment
Authors: xuehao
Date: 2019-12-21 00:13
Modified: 2019-12-18 22:06
Summary: 学习搭建C语言编程环境，学习编译开源C程序库，利用现有代码解决问题。
Category: 笔记
Tags: C Programming
Status: published

## 0. 目标

- 学习创建个人 _root_ 系统
- 学习从源码编译常用程序库
- 构建包含库的 C 程序

## 1. 创建个人 root 系统

所谓的个人 _root_ 系统，其实就是避免把软件安装到系统路径。这样我们可以方便的查看 _root_ 目录下的文件，审查所安装软件的具体行为，而不必到系统目录中查找。创建个人 _root_ 系统还可以避免使用系统 _root_ 权限。[ref]Ben Klemens. C 程序设计新思维, 第 2 版[M]. 赵岩, 译. 北京: 人民邮电出版社, 2018.[/ref]

创建 _root_ 系统目录：

```shell
$ mkdir ~/root # 用于保存非系统程序库
```

将个人 _root_ 系统目录添加到系统路径：

```shell
export PATH=$HOME/root/bin:$PATH # 以 zsh 举例，添加到 .zshrc
```

其实，这样的个人路径，在类似 _Ubuntu_ 的系统中已经默认存在了，即个人文件夹下的 `.local` 目录。如果你愿意，完全可以使用该目录，而且不需要去修改系统路径。

## 2. 从源码编译程序库

学习 C 语言完全可以像学习 Python 那样，直接使用现成的库。在 C 语言几十年的发展过程中，除了标准库的更新外，还产生了无数质量上乘的第三方库。利用这些库，我们可以更愉快的编程了。

下面会以 _GSL_ 库为例，介绍类似第三方库的安装和使用方法，为后续学习其他的库奠定基础。

下载 `GSL` 源码并编译安装：

```shell
$ wget  http://mirrors.ustc.edu.cn/gnu/gsl/gsl-2.6.tar.gz
$ tar xvzf gsl-2.6.tar.gz
$ cd gsl-2.6
$ ./configure --prefix=$HOME/root # 使用 prefix 参数指定安装目录
$ make && make install
```

该程序库将被添加到个人 _root_ 系统，可以去目录中查看具体安装了哪些东西。

## 3. 构建包含库的 C 程序

编写测试程序：

```c
// 文件名：gsl_erf.c
#include <math.h>        //erf, sqrt 等
#include <stdio.h>       //printf 等
#include <gsl/gsl_cdf.h>

int
main()
{
  double bottom_tail = gsl_cdf_gaussian_P(-1.96, 1);
  printf("Area between [-1.96, 1.96]: %g\n", 1 - 2 * bottom_tail);
}
```

编写 _Makefile_ 文件，通过 _-I_ 指定库的头文件搜索路径；通过 _-L_ 指定库的搜索路径：

```shell
CFLAGS=-I${HOME}/root/include -g -Wall -std=gnu11 -O3
LDLIBS=-L${HOME}/root/lib -lgsl -lgslcblas -lm
```

或者使用 _GSL_ 自带的配置信息，该命令会自动计算出相关的路径：

```shell
CFLAGS=`gsl-config --cflags` -g -Wall -std=gnu11 -O3
LDLIBS=`gsl-config --libs`
```

编译测试程序：

```shell
$ make gsl_erf
```

_Makefile_ 编译过程的套路一般为：

- 设置编译器选项的变量：_CFLAGS_ 为我们提供了编译器的一些选项
- 设置连接器选项的变量：_LDLIBS_ 为我们提供了连接器的一些选项。
- 使用 make 等工具将变量转换成真正的编译和连接的命令

| 常用编译器选项 |                 说明                 |
| :------------: | :----------------------------------: |
|       -g       |             加入调试符号             |
|     -Wall      |            添加编译器警告            |
|   -std=gun11   |           编译器版本为 C11           |
|      -O3       |             优化等级为 3             |
|       -o       | 指定输出的文件名，默认文件名为 a.out |

| 常用连接器选项 |                        说明                        |
| :------------: | :------------------------------------------------: |
|  -I(大写的 i)  |                 添加头文件搜索路径                 |
|       -L       |                 添加库文件搜索路径                 |
|  -l(小写的 L)  | 指定需要连接的库：`-lgsl` 自动连接名为 libgsl.a 库 |

运行测试程序：

```shell
$ export LD_LIBRARY_PATH=$HOME/root/lib:$LD_LIBRARY_PATH # 指定库路径
$ ./gsl_erf
Area between [-1.96, 1.96]: 0.950004
```

对于运行时需要连接共享库的程序，和编译过程一样，同样需要指定库的路径，可以通过修改 _LD_LIBRARY_PATH_ 变量实现。

---
*参考文献:*
